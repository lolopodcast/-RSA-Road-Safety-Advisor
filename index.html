import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  User, Mail, ArrowRight, Sun, Thermometer, Gauge, 
  MapPin, Plus, Trash2, Globe, Moon, Sun as SunIcon,
  Footprints, Bike, Car, Bus, GraduationCap, CheckCircle, XCircle,
  BookOpen, Shield, AlertTriangle, Lightbulb, Activity, PlayCircle,
  Cloud, Moon as MoonIcon, BarChart3, 
  Triangle, Square, RotateCcw, Building,
  ExternalLink, MousePointer2, Eye, EyeOff, LogOut, ZoomIn, ZoomOut, Link as LinkIcon,
  Download
} from 'lucide-react';

// --- Constants & Dictionary ---

const LINKS = {
  prof: "https://www.ibs.ncnu.edu.tw/index.php/faculty/tenured-professor/299-smlo",
  ibs: "https://www.ibs.ncnu.edu.tw/",
  ncnu: "https://rpage.ncnu.edu.tw/"
};

const SCHOOLS = [
  "國立暨南國際大學 (National Chi Nan University)",
  "國立台灣大學 (National Taiwan University)",
  "國立清華大學 (National Tsing Hua University)",
  "國立交通大學 (National Chiao Tung University)",
  "國立政治大學 (National Chengchi University)"
];

const LOCATIONS = {
  start: ["校門口 (Main Gate)", "學生宿舍 (Dormitory)", "行政大樓 (Admin Bldg)"],
  end: ["轉運站 (Bus Station)", "市區中心 (City Center)", "火車站 (Train Station)"]
};

const MAP_CENTER = { lat: 23.952, lon: 120.927 };
const DEFAULT_SCHOOL = "國立暨南國際大學 (National Chi Nan University)";

const UI_TEXT = {
  zh: {
    brandSubtitle: "道路風險與道安教練",
    slogan: "Know Well, Stay Safe",
    valueProp: "道路風險與道安教練",
    loginTime: "登入時間",
    username: "使用者名稱 (必填)",
    email: "使用者 Email (選填)",
    selectSchool: "選擇學校",
    enterName: "輸入您的姓名",
    enterEmail: "name@example.com",
    btnRisk: "開始風險評估",
    btnGuide: "探索安全指引",
    btnCap: "檢測安全能力",
    btnRecord: "查看學習紀錄",
    btnOfficial: "全國道安資訊",
    logout: "登出",
    creator: "Creator: Prof. Shihmin Lo, PhD",
    weather: "天氣概況",
    traffic: "交通忙碌",
    transport: "交通工具",
    departureTime: "出發時間",
    mapOptions: "路徑設定",
    scale: "比例尺",
    addStop: "新增中途點",
    start: "出發地",
    end: "目的地",
    mapGate: "校門口",
    mapStation: "轉運站",
    mapStop: "停靠",
    tabRisk: "風險評估",
    tabGuide: "安全指引",
    tabCap: "安全能力",
    tabRecord: "學習紀錄",
    tabOfficial: "道安資訊網",
    summary: "重點摘要",
    knowledge: "必備知識",
    skills: "必備技能",
    attitude: "必備態度",
    quiz: "牛刀小試 (隨機3題)",
    quizScore: "本單元得分",
    checkAns: "檢查答案",
    tryAgain: "再試一次",
    glossary: "字彙解釋 (完整收錄)",
    selectTerm: "請選擇詞彙查看解釋...",
    glossaryDef: "定義與說明",
    footerRights: "版權所有",
    lastUpdate: "最後更新",
    userProfile: "使用者資料",
    learningProgress: "學習進度總覽",
    correctRate: "答對率",
    questions: "題",
    score: "分",
    statusHigh: "優秀",
    statusMid: "良好",
    statusLow: "待加強",
    mapSimNote: "操作說明：滾輪縮放地圖，按住左鍵拖曳移動",
    flipHint: "點擊翻轉",
    mapModeSim: "情境模擬",
    mapModeReal: "真實地圖 (OSM)",
    officialTitle: "全國道路安全資訊與資源",
    officialChartTitle: "近年全國道路交通事故死亡人數趨勢 (模擬數據)",
    officialLinks: "重要官方資源連結",
    togglePanel: "儀表板設定",
    toggleMap: "地圖顯示",
    toggleContent: "詳細內容",
    exportCSV: "匯出學習紀錄 (CSV)"
  },
  en: {
    brandSubtitle: "Road Risk & Safety Coach",
    slogan: "Know Well, Stay Safe",
    valueProp: "Your Road Safety Companion",
    loginTime: "Login Time",
    username: "User Name (Required)",
    email: "User Email (Optional)",
    selectSchool: "Select School",
    enterName: "Enter your name",
    enterEmail: "name@example.com",
    btnRisk: "Start Risk Assessment",
    btnGuide: "Explore Safety Guidelines",
    btnCap: "Check Safety Capability",
    btnRecord: "View Learning Record",
    btnOfficial: "National Safety Info",
    logout: "Log Out",
    creator: "Creator: Prof. Shihmin Lo, PhD",
    weather: "Weather",
    traffic: "Traffic",
    transport: "Transport",
    departureTime: "Time",
    mapOptions: "Route Settings",
    scale: "Scale",
    addStop: "Add Stop",
    start: "Start",
    end: "End",
    mapGate: "Main Gate",
    mapStation: "Station",
    mapStop: "Stop",
    tabRisk: "Risk Assessment",
    tabGuide: "Safety Guidelines",
    tabCap: "Safety Capability",
    tabRecord: "Learning Record",
    tabOfficial: "Official Info",
    summary: "Summary",
    knowledge: "Essential Knowledge",
    skills: "Essential Skills",
    attitude: "Essential Attitude",
    quiz: "Quick Quiz (Random 3)",
    quizScore: "Score",
    checkAns: "Check Answers",
    tryAgain: "Try Again",
    glossary: "Key Vocabulary",
    selectTerm: "Select a term to define...",
    glossaryDef: "Definition",
    footerRights: "All Rights Reserved",
    lastUpdate: "Last Updated",
    userProfile: "User Profile",
    learningProgress: "Learning Progress",
    correctRate: "Accuracy",
    questions: "Qs",
    score: "Pts",
    statusHigh: "Excellent",
    statusMid: "Good",
    statusLow: "Needs Improvement",
    mapSimNote: "Usage: Scroll to Zoom, Drag to Pan",
    flipHint: "Click to flip",
    mapModeSim: "Simulation",
    mapModeReal: "Real Map (OSM)",
    officialTitle: "National Road Safety Information & Resources",
    officialChartTitle: "Annual Road Traffic Fatalities Trend (Simulated)",
    officialLinks: "Important Official Resources",
    togglePanel: "Dashboard",
    toggleMap: "Map View",
    toggleContent: "Details",
    exportCSV: "Export CSV"
  }
};

const QUIZ_POOL_SIZE = 9;
const QUIZ_DISPLAY_COUNT = 3;

const getRandomIndices = (total, count) => {
  const indices = Array.from({ length: total }, (_, i) => i);
  const shuffled = indices.sort(() => 0.5 - Math.random());
  return shuffled.slice(0, count);
};

const CONTENT_DATA = {
  risk: {
    zh: {
      title: "風險評估",
      summary: "基於當前環境條件與路徑拓撲的潛在道路危險綜合分析。",
      knowledge: [
        { title: "視線死角熱區", desc: "大型車輛轉彎時的內輪差區域識別與迴避。車體越長，內輪差越大，機車騎士應避免進入此紅區。" },
        { title: "路面摩擦係數", desc: "雨天路面摩擦力下降。金屬溝蓋與標線在濕滑時如同冰面，應避免在上方煞車或轉彎。" },
        { title: "防禦性駕駛預判", desc: "不只顧好自己。觀察前車動態、路口是否有車輛可能衝出，預留緩衝空間與反應時間。" }
      ],
      skills: [
        { title: "緊急煞車控制", desc: "ABS作動時的正確操控與重心轉移技巧。保持龍頭回正，前後煞車同時使用。" },
        { title: "視線掃描頻率", desc: "建立每5-8秒掃描後視鏡的動態視覺習慣，隨時掌握後方與側邊車流。" },
        { title: "盲點檢查", desc: "變換車道前的肩部檢查動作 (Shoulder Check)，確認照後鏡死角無車。" }
      ],
      attitude: [
        { title: "風險趨避意識", desc: "主動選擇較安全而非最快的路徑。寧可繞道也不搶快通過危險路口。" },
        { title: "耐心與禮讓", desc: "理解路權並在模糊地帶主動禮讓。不與違規者爭道，保持情緒穩定。" },
        { title: "自我狀態監控", desc: "疲勞與情緒波動時的駕駛決策調整。察覺狀態不佳時主動減速或停車休息。" }
      ],
      glossary: [
        { term: "內輪差 (Inner Wheel Difference)", def: "車輛轉彎時，內側前輪畫出的圓半徑大於內側後輪，兩者軌跡的差距稱為內輪差，是大型車捲入事故的主因。" },
        { term: "防禦性駕駛 (Defensive Driving)", def: "一種駕駛哲學，強調預想周遭可能的危險並預先採取預防措施，而非僅依賴法規或技術。" },
        { term: "盲點 (Blind Spot)", def: "駕駛人透過後視鏡或直接視線無法看見的車輛周圍區域，變換車道前必須特別檢查。" },
        { term: "水漂效應 (Aquaplaning)", def: "車輛行駛過積水時，輪胎與路面間形成水膜，導致輪胎失去抓地力而失控的現象。" },
        { term: "煞車距離 (Braking Distance)", def: "從踩下煞車到車輛完全停止所行駛的距離，隨速度平方增加。" },
        { term: "反應距離 (Reaction Distance)", def: "從察覺危險到踩下煞車期間車輛行駛的距離。" },
        { term: "A柱死角 (A-Pillar Blind Spot)", def: "車輛擋風玻璃兩側支柱遮蔽駕駛視線的區域，轉彎時特別危險。" },
        { term: "路權 (Right of Way)", def: "法律賦予特定用路人在特定路況下優先通行的權利。" },
        { term: "追撞 (Rear-end Collision)", def: "後車撞擊前車車尾的事故，通常因未保持安全距離造成。" },
        { term: "鬼探頭", def: "行人或車輛突然從遮蔽物（如公車、違停車輛）後方衝出的危險情況。" },
        { term: "視覺隧道效應 (Tunnel Vision)", def: "速度越快，駕駛人的視野角度越窄，容易忽略兩側危險。" }
      ],
      quizPool: [
        { q: "大型車輛右轉時，機車騎士最危險的位置是?", options: ["車輛正後方", "右側內輪差區域", "左側超車道"], ans: 1 },
        { q: "雨天騎經人孔蓋或標線時，應如何操作?", options: ["急煞減速", "保持等速直線通過", "壓車過彎"], ans: 1 },
        { q: "防禦性駕駛的核心精神為何?", options: ["預設其他用路人可能犯錯", "技術高超所以開快", "只管自己的路權"], ans: 0 },
        { q: "行經路口看到綠燈，正確做法是?", options: ["加速通過", "減速並觀察左右", "停車再開"], ans: 1 },
        { q: "發現大型車輛在前方，應該?", options: ["緊跟在後", "保持更長的安全距離", "從右側超車"], ans: 1 },
        { q: "夜間行駛在無路燈路段，應使用?", options: ["近光燈", "遠光燈(對向無車時)", "霧燈"], ans: 1 },
        { q: "遇到救護車鳴笛時?", options: ["加速行駛", "避讓至路邊", "不予理會"], ans: 1 },
        { q: "機車輪胎紋路深度不足會導致?", options: ["抓地力下降", "極速增加", "省油"], ans: 0 },
        { q: "行駛中手機響起，應該?", options: ["邊騎邊接", "靠邊停車安全後再接", "用肩膀夾著聽"], ans: 1 }
      ]
    },
    en: {
      title: "Risk Assessment",
      summary: "Comprehensive analysis of potential road hazards based on current conditions.",
      knowledge: [
        { title: "Blind Spot Zones", desc: "Identifying inner wheel difference areas. The longer the vehicle, the wider the gap. Avoid this red zone." },
        { title: "Road Friction", desc: "Friction drops in rain. Metal covers and painted lines become ice-like. Avoid braking or turning on them." },
        { title: "Defensive Driving", desc: "Look beyond yourself. Observe lead vehicles and intersections. Leave buffer space and reaction time." }
      ],
      skills: [
        { title: "Emergency Braking", desc: "Correct control and weight transfer when ABS activates. Keep handlebars straight." },
        { title: "Visual Scanning", desc: "Habit of checking mirrors every 5-8 seconds to monitor traffic flow." },
        { title: "Blind Spot Check", desc: "Shoulder check before changing lanes to verify the mirror's blind spot is clear." }
      ],
      attitude: [
        { title: "Risk Aversion", desc: "Choosing safer routes over fastest ones. Avoid rushing through dangerous intersections." },
        { title: "Patience", desc: "Yielding in ambiguous situations. Do not compete with violators; maintain emotional stability." },
        { title: "Self-Monitoring", desc: "Adjusting decisions during fatigue. Slow down or rest if you feel unwell." }
      ],
      glossary: [
        { term: "Inner Wheel Difference", def: "Difference in tracks between inner front and rear wheels during a turn." },
        { term: "Defensive Driving", def: "Anticipating potential hazards and taking preemptive action." },
        { term: "Blind Spot", def: "Areas not seen via mirrors, requiring a shoulder check." },
        { term: "Aquaplaning", def: "Loss of traction due to water layer between tires and road." },
        { term: "Braking Distance", def: "Distance traveled from braking input to full stop." },
        { term: "Reaction Distance", def: "Distance traveled between perceiving danger and hitting brakes." },
        { term: "A-Pillar Blind Spot", def: "Visual obstruction caused by the windshield pillars." },
        { term: "Right of Way", def: "Legal right to proceed before others in specific situations." },
        { term: "Rear-end Collision", def: "Accident where a vehicle hits the one in front of it." },
        { term: "Tunnel Vision", def: "Narrowing of visual field as speed increases." },
        { term: "Traction", def: "The grip of the tire on the road surface." }
      ],
      quizPool: [
        { q: "Most dangerous spot near a turning truck?", options: ["Behind", "Inner wheel area", "Left lane"], ans: 1 },
        { q: "Handling manhole covers in rain?", options: ["Brake hard", "Straight line, constant speed", "Lean"], ans: 1 },
        { q: "Core of defensive driving?", options: ["Expect errors from others", "Speed", "Right of way only"], ans: 0 },
        { q: "Green light at intersection?", options: ["Speed up", "Slow down & look", "Stop"], ans: 1 },
        { q: "Large vehicle ahead?", options: ["Tailgate", "Increase distance", "Pass on right"], ans: 1 },
        { q: "No streetlights at night?", options: ["Low beam", "High beam (if clear)", "Fog lights"], ans: 1 },
        { q: "Ambulance siren?", options: ["Speed up", "Pull over", "Ignore"], ans: 1 },
        { q: "Worn tire tread causes?", options: ["Less grip", "More speed", "Fuel saving"], ans: 0 },
        { q: "Phone rings while riding?", options: ["Answer", "Pull over safely", "Shoulder hold"], ans: 1 }
      ]
    }
  },
  guidelines: {
    zh: {
      title: "安全指引",
      summary: "最佳道路安全的標準作業程序 (SOP) 與法規遵循。",
      knowledge: [
        { title: "路權優先順序", desc: "支道讓幹道、轉彎讓直行、左方讓右方。這不是禮貌，是法律規定的通行次序。" },
        { title: "速限與路況", desc: "法規速限是「最高」限制，非「建議」速度。雨天或視線不良時應低於速限行駛。" },
        { title: "號誌辨識", desc: "閃光紅燈=停車再開。閃光黃燈=減速接近。圓形綠燈可左轉(若無標示)，箭頭綠燈需依指示。" }
      ],
      skills: [
        { title: "正確配戴裝備", desc: "安全帽頤帶調整與護具穿戴標準。頤帶應保留一指幅空間，避免脫落。" },
        { title: "車輛行前檢查", desc: "五油三水與胎紋胎壓的快速檢核流程。確認燈光與喇叭運作正常。" },
        { title: "燈號使用時機", desc: "方向燈應在轉彎或變換車道前30公尺開啟，確認後方無車再動作。" }
      ],
      attitude: [
        { title: "守法精神", desc: "將交通規則視為安全保障而非限制。不搶黃燈，不闖紅燈。" },
        { title: "尊重弱勢", desc: "對行人與自行車騎士的絕對禮讓。行經斑馬線必減速。" },
        { title: "責任感", desc: "對自身駕駛行為可能造成的後果負責。不酒駕，不疲勞駕駛。" }
      ],
      glossary: [
        { term: "停讓 (Stop and Yield)", def: "在無號誌路口或設有停讓標誌處，車輛必須完全停止，確認無來車後再開。" },
        { term: "兩段式左轉 (Two-stage Left Turn)", def: "機車在特定路口需先直行至待轉區，等待燈號變換後再通行的規定。" },
        { term: "安全距離 (Following Distance)", def: "與前車保持的距離，應足以在突發狀況下安全煞停，通常建議至少2秒。" },
        { term: "路面標線 (Road Markings)", def: "道路上用以指示、警告或禁止的線條，如雙黃線禁止跨越。" },
        { term: "雙黃線 (Double Yellow Line)", def: "禁止跨越對向車道行駛或迴轉的標線。" },
        { term: "圓環 (Roundabout)", def: "環狀交岔路口，進入車輛應禮讓環內行駛車輛。" },
        { term: "路肩 (Shoulder)", def: "道路外側供緊急停車使用之區域，非緊急狀況不得行駛。" },
        { term: "讓路線 (Yield Line)", def: "倒三角形標線，表示駕駛人應減速或停車，禮讓幹道車先行。" },
        { term: "全罩式安全帽 (Full-face Helmet)", def: "包覆頭部與下巴的安全帽，提供最佳防護力。" },
        { term: "五油三水", def: "車輛檢查口訣：汽油、機油、變速箱油、煞車油、動力方向機油；水箱水、雨刷水、電瓶水。" },
        { term: "絕對路權", def: "行人穿越道上的行人擁有優先通行權，車輛必須絕對禮讓。" }
      ],
      quizPool: [
        { q: "閃光紅燈表示應該?", options: ["減速通過", "停車再開", "加速通過"], ans: 1 },
        { q: "機車安全帽頤帶與下巴的間隙應為?", options: ["1-2指幅", "越鬆越好", "緊貼無法張口"], ans: 0 },
        { q: "變換車道應在多久前打方向燈?", options: ["變換同時", "變換後", "全程顯示直至完成"], ans: 2 },
        { q: "雙黃線表示?", options: ["可以超車", "禁止跨越", "可以迴轉"], ans: 1 },
        { q: "圓形紅燈可以右轉嗎?", options: ["可以", "不行", "看情況"], ans: 1 },
        { q: "進入圓環應讓?", options: ["環內車先行", "進入車先行", "誰快誰先"], ans: 0 },
        { q: "行人穿越道有行人時?", options: ["鳴笛通過", "繞過行人", "暫停禮讓"], ans: 2 },
        { q: "經過積水路段?", options: ["加速通過", "減速慢行", "急煞"], ans: 1 },
        { q: "路邊起步應先?", options: ["打方向燈並看後照鏡", "直接切入", "鳴笛"], ans: 0 }
      ]
    },
    en: {
      title: "Safety Guidelines",
      summary: "SOP and regulatory compliance for road safety.",
      knowledge: [
        { title: "Right of Way", desc: "Minor yields to major. It is law, not just courtesy. Straight traffic has priority over turning." },
        { title: "Speed Limits", desc: "Limits are maximums. Drive below limits in poor visibility or rain." },
        { title: "Signal Recognition", desc: "Flashing Red = Stop. Flashing Yellow = Slow. Arrow lights dictate direction." }
      ],
      skills: [
        { title: "Gear Usage", desc: "Helmet strap adjustment (1-2 fingers gap). Ensure protective gear is fastened." },
        { title: "Inspection", desc: "Pre-ride check for fluids, tires, brakes, lights, and horn." },
        { title: "Signaling", desc: "Use turn signals 30m before turning. Check mirrors before signaling." }
      ],
      attitude: [
        { title: "Law Abidance", desc: "Traffic rules are safety guarantees. Do not run red or amber lights." },
        { title: "Respect", desc: "Absolute yielding to pedestrians and cyclists at crossings." },
        { title: "Responsibility", desc: "Taking ownership of consequences. No DUI, no drowsy driving." }
      ],
      glossary: [
        { term: "Stop and Yield", def: "Complete stop at signs before proceeding." },
        { term: "Two-stage Left Turn", def: "Scooters must wait in box before turning left." },
        { term: "Following Distance", def: "Keep at least 2 seconds distance." },
        { term: "Road Markings", def: "Lines instructing or prohibiting actions." },
        { term: "Double Yellow Line", def: "Strictly prohibits crossing or U-turns." },
        { term: "Roundabout", def: "Circular intersection; yield to traffic inside." },
        { term: "Shoulder", def: "Emergency stopping area on the side of the road." },
        { term: "Yield Line", def: "Indicates necessity to yield to major road traffic." },
        { term: "Full-face Helmet", def: "Helmet covering head and chin for max protection." },
        { term: "Pre-trip Inspection", def: "Routine check of vehicle condition before driving." },
        { term: "Pedestrian Priority", def: "Vehicles must yield to pedestrians on crosswalks." }
      ],
      quizPool: [
        { q: "Flashing red light?", options: ["Slow", "Stop", "Speed up"], ans: 1 },
        { q: "Helmet strap gap?", options: ["1-2 fingers", "Loose", "Tight"], ans: 0 },
        { q: "When to signal?", options: ["During", "After", "Before & During"], ans: 2 },
        { q: "Double yellow line?", options: ["Pass", "No Crossing", "U-turn"], ans: 1 },
        { q: "Right turn on red circle?", options: ["Yes", "No", "Maybe"], ans: 1 },
        { q: "Roundabout priority?", options: ["Inside vehicle", "Entering vehicle", "Fastest"], ans: 0 },
        { q: "Pedestrian at crosswalk?", options: ["Honk", "Go around", "Stop & Yield"], ans: 2 },
        { q: "Water puddle?", options: ["Speed up", "Slow down", "Brake hard"], ans: 1 },
        { q: "Starting from curb?", options: ["Signal & Look", "Go", "Honk"], ans: 0 }
      ]
    }
  },
  capability: {
    zh: {
      title: "安全能力",
      summary: "生理準備狀態與技術熟練度評估。",
      knowledge: [
        { title: "疲勞生理徵兆", desc: "微睡眠(Microsleep)是極度危險訊號。若發現頻繁眨眼或斷片，應立即停車。" },
        { title: "藥物副作用", desc: "感冒藥常含抗組織胺，會導致嗜睡。服用後應避免駕駛或改搭大眾運輸。" },
        { title: "車輛極限認知", desc: "雙載或載重物時，煞車距離變長，轉彎極限降低，需提早煞車。" }
      ],
      skills: [
        { title: "緊急閃避", desc: "在不失控前提下的快速變換軌跡能力。視線看要去的地方，而非障礙物。" },
        { title: "視線穩定", desc: "顛簸路面保持視線水平與專注的能力。身體放鬆，膝蓋夾緊油箱(機車)。" },
        { title: "空間感知", desc: "精準判斷車身寬度與周遭障礙物距離。通過狹窄路段時的自信與判斷。" }
      ],
      attitude: [
        { title: "持續學習", desc: "定期更新交通法規與駕駛技術的意願。參加安駕課程。" },
        { title: "自我誠實", desc: "誠實評估身心狀態是否適合駕駛。情緒不穩時不駕車。" },
        { title: "冷靜應變", desc: "遭遇突發狀況時的情緒控制與理性決策。發生事故時保持冷靜並報警。" }
      ],
      glossary: [
        { term: "反應時間 (Reaction Time)", def: "從察覺危險到開始採取行動所需的時間。" },
        { term: "動態視力 (Dynamic Visual Acuity)", def: "在移動狀態下辨識物體細節的能力，隨速度增加而下降。" },
        { term: "微睡眠 (Microsleep)", def: "極短暫的意識喪失，常發生於疲勞駕駛時。" },
        { term: "預判力 (Anticipation)", def: "基於經驗預測道路上其他使用者可能動向的能力。" },
        { term: "抗壓力 (Stress Tolerance)", def: "在交通擁堵或突發狀況下保持冷靜的能力。" },
        { term: "手眼協調 (Hand-eye Coordination)", def: "視覺接收訊息與手腳操作車輛的同步配合能力。" },
        { term: "肌肉記憶 (Muscle Memory)", def: "透過反覆練習，使駕駛操作成為下意識的自動反應。" },
        { term: "空間感 (Spatial Awareness)", def: "對車輛在環境中位置與體積的感知能力。" },
        { term: "酒測值 (BAC)", def: "血液酒精濃度，超過法規標準即為酒駕。" },
        { term: "情緒駕駛 (Road Rage)", def: "因交通狀況產生的憤怒情緒，導致攻擊性駕駛行為。" },
        { term: "隧道視野", def: "專注於單一點而忽略周邊環境的視覺現象，常發生於高速或緊張時。" }
      ],
      quizPool: [
        { q: "服用抗組織胺藥物後?", options: ["精神更好", "可能嗜睡", "無影響"], ans: 1 },
        { q: "突發障礙物，視線應?", options: ["盯著障礙物", "看安全出口", "閉眼"], ans: 1 },
        { q: "長途駕駛休息頻率?", options: ["4小時", "2小時", "不用"], ans: 1 },
        { q: "生氣時駕駛?", options: ["開快點洩憤", "深呼吸冷靜或不開", "大吼大叫"], ans: 1 },
        { q: "煞車時重心會?", options: ["後移", "前移", "不變"], ans: 1 },
        { q: "輪胎磨平會影響?", options: ["排水性", "油耗", "冷氣"], ans: 0 },
        { q: "載人時煞車距離?", options: ["變短", "變長", "不變"], ans: 1 },
        { q: "酒後駕車?", options: ["喝少沒關係", "絕對禁止", "騎慢點"], ans: 1 },
        { q: "看到球滾出來?", options: ["加速通過", "預測有小孩衝出", "按喇叭"], ans: 1 }
      ]
    },
    en: {
      title: "Safety Capability",
      summary: "Physiological readiness and technical proficiency.",
      knowledge: [
        { title: "Fatigue Signs", desc: "Microsleep is dangerous. Stop if blinking frequently or losing focus." },
        { title: "Medication", desc: "Cold meds cause drowsiness. Avoid driving or use public transport." },
        { title: "Vehicle Limits", desc: "Braking distance increases with passenger. Cornering limits decrease." }
      ],
      skills: [
        { title: "Emergency Evasion", desc: "Quickly changing trajectory. Look where you want to go, not at the obstacle." },
        { title: "Visual Stability", desc: "Maintaining focus on bumpy roads. Relax body, grip tank with knees." },
        { title: "Spatial Awareness", desc: "Judging vehicle width and distance in tight spaces." }
      ],
      attitude: [
        { title: "Continuous Learning", desc: "Updating skills regularly. Attending safety courses." },
        { title: "Self-Honesty", desc: "Assessing fitness to drive. Don't drive when emotional." },
        { title: "Calm Response", desc: "Emotional control in emergencies. Stay calm after incidents." }
      ],
      glossary: [
        { term: "Reaction Time", def: "Time from perception to action." },
        { term: "Dynamic Visual Acuity", def: "Seeing details while moving." },
        { term: "Microsleep", def: "Brief loss of consciousness." },
        { term: "Anticipation", def: "Predicting other road users' actions." },
        { term: "Stress Tolerance", def: "Staying calm in traffic." },
        { term: "Hand-eye Coordination", def: "Syncing vision with controls." },
        { term: "Muscle Memory", def: "Automatic reactions from practice." },
        { term: "Spatial Awareness", def: "Sensing vehicle position." },
        { term: "BAC", def: "Blood Alcohol Concentration." },
        { term: "Road Rage", def: "Aggressive driving due to anger." },
        { term: "Tunnel Vision", def: "Loss of peripheral sight." }
      ],
      quizPool: [
        { q: "Antihistamines effect?", options: ["Alert", "Drowsy", "None"], ans: 1 },
        { q: "Sudden obstacle, look at?", options: ["Obstacle", "Safe path", "Close eyes"], ans: 1 },
        { q: "Long drive rest?", options: ["4 hrs", "2 hrs", "None"], ans: 1 },
        { q: "Driving while angry?", options: ["Drive fast", "Calm down", "Scream"], ans: 1 },
        { q: "Braking weight transfer?", options: ["Back", "Front", "None"], ans: 1 },
        { q: "Worn tires affect?", options: ["Drainage", "Fuel", "AC"], ans: 0 },
        { q: "Braking with passenger?", options: ["Shorter", "Longer", "Same"], ans: 1 },
        { q: "Drink driving?", options: ["Little is ok", "Prohibited", "Drive slow"], ans: 1 },
        { q: "Ball rolls into street?", options: ["Speed up", "Expect child", "Honk"], ans: 1 }
      ]
    }
  }
};

// --- Dynamic Data Generators ---
const getSimulationData = (timeSlot) => {
  switch(timeSlot) {
    case '08:00': return { temp: 24, condition: "Partly Cloudy", icon: Sun, trafficLoad: 90, trafficStatus: "Rush Hour", isNight: false };
    case '12:00': return { temp: 32, condition: "Sunny", icon: Sun, trafficLoad: 60, trafficStatus: "Moderate", isNight: false };
    case '17:00': return { temp: 29, condition: "Cloudy", icon: Cloud, trafficLoad: 95, trafficStatus: "Heavy", isNight: false };
    case '22:00': return { temp: 22, condition: "Clear", icon: MoonIcon, trafficLoad: 20, trafficStatus: "Light", isNight: true };
    case 'now':
    default:
      const hour = new Date().getHours();
      const isNightNow = hour >= 18 || hour < 6;
      return { 
        temp: 28, condition: isNightNow ? "Clear" : "Sunny", icon: isNightNow ? MoonIcon : Sun,
        trafficLoad: (hour >= 7 && hour <= 9) || (hour >= 17 && hour <= 19) ? 85 : 45,
        trafficStatus: "Normal",
        isNight: isNightNow
      };
  }
};

// --- Sub-Components ---

const HeroSection = ({ isCompact = false, lang = 'zh' }) => {
  const t = UI_TEXT[lang];
  if (isCompact) {
    return (
      <div className="flex flex-col justify-center bg-emerald-700 p-2 px-4 rounded-sm shadow-sm text-white min-w-[180px]">
        <div className="flex items-center gap-2">
          <Shield className="w-6 h-6 text-emerald-300" />
          <h1 className="text-2xl font-bold tracking-tight font-sans">RSA</h1>
        </div>
        <div className="text-emerald-100 font-bold text-[10px] tracking-widest uppercase">ROAD SAFETY ADVISOR</div>
      </div>
    );
  }
  return (
    <div className="flex flex-col items-center text-center transition-all duration-300">
      <div className="text-slate-500 font-bold text-sm mb-2 tracking-wide">{t.brandSubtitle}</div>
      <div className="flex items-center gap-2 mb-1">
        <Shield className="w-10 h-10 text-emerald-600" />
        <h1 className="text-4xl font-bold tracking-tight text-slate-800 dark:text-white font-sans">RSA</h1>
      </div>
      <div className="text-emerald-700 dark:text-emerald-400 font-semibold text-sm tracking-widest uppercase mb-2">Road Safety Advisor</div>
      <h2 className="text-xl font-medium text-slate-600 dark:text-slate-300 italic serif">"{t.slogan}"</h2>
      <p className="text-sm text-slate-500 dark:text-slate-400 mt-1 font-medium">{t.valueProp}</p>
    </div>
  );
};

const ScooterIcon = () => (
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <circle cx="16" cy="17" r="4" />
    <path d="M5 17h-2v-6l2-1h3l4 3.5" />
    <path d="M7 17l1.5-6h4.5" />
    <path d="M12 5h2.5l2 3" />
  </svg>
);

const FlipCard = ({ item, lang, isOpen, onToggle }) => {
  const t = UI_TEXT[lang];

  return (
    <div 
      className="relative w-full h-32 cursor-pointer group"
      onClick={(e) => {
        if (!isOpen) {
          e.stopPropagation();
          onToggle();
        }
      }}
      style={{ perspective: '1000px' }}
    >
      <div 
        className="w-full h-full transition-all duration-500"
        style={{ 
          transformStyle: 'preserve-3d',
          transform: isOpen ? 'rotateY(180deg)' : 'rotateY(0deg)'
        }}
      >
        {/* Front */}
        <div 
          className="absolute inset-0 bg-white dark:bg-slate-800 p-4 rounded-sm shadow-sm border-l-4 border-blue-500 flex flex-col justify-center items-center text-center"
          style={{ backfaceVisibility: 'hidden' }}
        >
           <h4 className="font-bold text-slate-700 dark:text-slate-200 text-sm">{item.title}</h4>
           <p className="text-[10px] text-blue-500 mt-2 flex items-center gap-1"><RotateCcw className="w-3 h-3" /> {t.flipHint}</p>
        </div>
        {/* Back */}
        <div 
          className="absolute inset-0 bg-blue-50 dark:bg-slate-700 p-4 rounded-sm shadow-sm border border-blue-200 dark:border-slate-600 flex items-center justify-center text-center"
          style={{ 
            backfaceVisibility: 'hidden', 
            transform: 'rotateY(180deg)' 
          }}
        >
           <p className="text-xs text-slate-600 dark:text-slate-200 pointer-events-none">{item.desc}</p>
        </div>
      </div>
    </div>
  );
};

const ThermometerWidget = ({ lang, data }) => (
  <div className="flex flex-col items-center justify-center p-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-sm shadow-sm h-full w-full relative overflow-hidden">
    <div className="w-full flex justify-between items-center mb-2 z-10">
       <div className="flex items-center gap-1">
          <data.icon className={`w-4 h-4 ${data.isNight ? 'text-blue-400' : 'text-amber-500'}`} />
          <span className="text-[10px] font-bold text-slate-500 uppercase">{UI_TEXT[lang].weather}</span>
       </div>
       <div className="text-sm font-bold text-slate-700 dark:text-slate-200">{data.temp}°C</div>
    </div>
    
    <div className="w-full bg-slate-100 dark:bg-slate-700 h-2 rounded-full overflow-hidden border border-slate-200 z-10">
       <div 
         className={`h-full transition-all duration-1000 ${data.temp > 30 ? 'bg-red-500' : 'bg-amber-400'}`}
         style={{ width: `${(data.temp / 45) * 100}%` }}
       ></div>
    </div>
    <div className="w-full text-right mt-1 text-[10px] text-slate-500 z-10">{data.condition}</div>
    <div className={`absolute -bottom-2 -right-2 w-12 h-12 rounded-full opacity-10 ${data.isNight ? 'bg-blue-500' : 'bg-amber-500'}`}></div>
  </div>
);

const TrafficGauge = ({ lang, data }) => (
  <div className="flex flex-col items-center justify-center p-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-sm shadow-sm h-full w-full relative overflow-hidden">
    <div className="w-full flex justify-between items-center mb-1 z-10">
       <div className="flex items-center gap-1">
          <Gauge className="w-4 h-4 text-emerald-500" />
          <span className="text-[10px] font-bold text-slate-500 uppercase">{UI_TEXT[lang].traffic}</span>
       </div>
       <div className={`text-sm font-bold ${data.trafficLoad > 80 ? 'text-red-500' : 'text-emerald-500'}`}>{data.trafficLoad}%</div>
    </div>
    
    <div className="w-full flex gap-1 h-2 mt-1 z-10">
       {[...Array(5)].map((_, i) => (
         <div 
           key={i} 
           className={`flex-1 rounded-sm transition-colors duration-500 ${
             i < (data.trafficLoad / 20) 
               ? (data.trafficLoad > 80 ? 'bg-red-500' : data.trafficLoad > 50 ? 'bg-amber-400' : 'bg-emerald-400') 
               : 'bg-slate-100 dark:bg-slate-700'
           }`}
         ></div>
       ))}
    </div>
    
    <div className="w-full text-right mt-1 text-[10px] text-slate-500 z-10">{data.trafficStatus}</div>
  </div>
);

const MapComponent = ({ lang, transport, waypoints, mapScale, isNight, trafficLoad, startLoc, endLoc, mapMode, setMapMode }) => {
  const t = UI_TEXT[lang];
  
  // Interactive Map State
  const [viewState, setViewState] = useState({ x: 0, y: 0, scale: 1.5 }); // Default 300m
  const [isDragging, setIsDragging] = useState(false);
  const [lastPos, setLastPos] = useState({ x: 0, y: 0 });
  const containerRef = useRef(null);

  // Sync scale prop to viewState scale AND OSM BBox
  const osmSrc = useMemo(() => {
    // Approx NCNU coords: 120.927, 23.952
    let delta = 0.005; // Default ~300m
    if (mapScale === 100) delta = 0.002;
    if (mapScale === 1000) delta = 0.015;
    
    const minLon = MAP_CENTER.lon - delta;
    const maxLon = MAP_CENTER.lon + delta;
    const minLat = MAP_CENTER.lat - delta;
    const maxLat = MAP_CENTER.lat + delta;
    
    return `https://www.openstreetmap.org/export/embed.html?bbox=${minLon}%2C${minLat}%2C${maxLon}%2C${maxLat}&amp;layer=mapnik`;
  }, [mapScale]);

  useEffect(() => {
    let newScale = 1.5;
    if (mapScale === 100) newScale = 2.5;
    if (mapScale === 300) newScale = 1.5;
    if (mapScale === 1000) newScale = 0.8;
    setViewState(prev => ({ ...prev, scale: newScale }));
  }, [mapScale]);

  const handleZoomIn = () => {
    setViewState(prev => ({ ...prev, scale: Math.min(prev.scale + 0.5, 5) }));
  };

  const handleZoomOut = () => {
    setViewState(prev => ({ ...prev, scale: Math.max(prev.scale - 0.5, 0.5) }));
  };

  const handleWheel = (e) => {
    e.preventDefault();
    e.stopPropagation();
    const scaleAdjustment = -e.deltaY * 0.001;
    setViewState(prev => ({
      ...prev,
      scale: Math.min(Math.max(prev.scale + scaleAdjustment, 0.5), 5)
    }));
  };

  const handleMouseDown = (e) => {
    setIsDragging(true);
    setLastPos({ x: e.clientX, y: e.clientY });
  };

  const handleMouseMove = (e) => {
    if (!isDragging) return;
    const dx = e.clientX - lastPos.x;
    const dy = e.clientY - lastPos.y;
    setViewState(prev => ({ ...prev, x: prev.x + dx, y: prev.y + dy }));
    setLastPos({ x: e.clientX, y: e.clientY });
  };

  const handleMouseUp = () => {
    setIsDragging(false);
  };

  // Traffic Color
  const mainRoadStroke = trafficLoad > 80 ? '#ef4444' : trafficLoad > 60 ? '#f59e0b' : (isNight ? '#475569' : '#fff');
  const startPos = startLoc.includes("Gate") || startLoc.includes("校門") ? { top: '55%', left: '45%' } : { top: '65%', left: '35%' };
  const endPos = endLoc.includes("Station") || endLoc.includes("轉運") ? { top: '35%', left: '65%' } : { top: '25%', left: '75%' };

  return (
    <div className={`
      border border-slate-300 dark:border-slate-600 rounded-sm w-full h-[400px] relative overflow-hidden group transition-colors duration-500
      ${isNight ? 'bg-slate-900' : 'bg-slate-100'}
    `}
    style={{ overscrollBehavior: 'contain' }} 
    >
      {/* Map Mode Toggle */}
      <div className="absolute top-2 left-2 z-40 flex bg-white/90 dark:bg-slate-800/90 rounded border border-slate-300 dark:border-slate-600 p-0.5">
         <button onClick={() => setMapMode('sim')} className={`px-2 py-1 text-[10px] font-bold rounded-sm ${mapMode === 'sim' ? 'bg-emerald-600 text-white' : 'text-slate-500'}`}>{t.mapModeSim}</button>
         <button onClick={() => setMapMode('real')} className={`px-2 py-1 text-[10px] font-bold rounded-sm ${mapMode === 'real' ? 'bg-emerald-600 text-white' : 'text-slate-500'}`}>{t.mapModeReal}</button>
      </div>

      {mapMode === 'real' ? (
        <iframe 
          width="100%" 
          height="100%" 
          frameBorder="0" 
          scrolling="no" 
          marginHeight="0" 
          marginWidth="0" 
          src={osmSrc}
          className="w-full h-full"
        ></iframe>
      ) : (
        <>
          <div 
            ref={containerRef}
            className="w-full h-full cursor-move touch-none"
            onWheel={handleWheel}
            onMouseDown={handleMouseDown}
            onMouseMove={handleMouseMove}
            onMouseUp={handleMouseUp}
            onMouseLeave={handleMouseUp}
          >
            <div 
              className="w-full h-full absolute inset-0 transition-transform duration-75 ease-out origin-center flex items-center justify-center"
              style={{ transform: `translate(${viewState.x}px, ${viewState.y}px) scale(${viewState.scale})` }}
            >
              {/* SVG Map Layer */}
              <div className="absolute inset-[-100%] bg-slate-50 dark:bg-slate-900 opacity-100">
                 {/* Grid */}
                 <div className="absolute inset-0" style={{ 
                   backgroundImage: `linear-gradient(${isNight ? '#1e293b' : '#cbd5e1'} 1px, transparent 1px), linear-gradient(90deg, ${isNight ? '#1e293b' : '#cbd5e1'} 1px, transparent 1px)`, 
                   backgroundSize: '40px 40px' 
                 }}></div>
                 
                 {/* Features */}
                 <div className="absolute top-[20%] left-[60%] w-[500px] h-[500px] bg-blue-200/50 dark:bg-blue-900/30 rounded-full blur-3xl pointer-events-none"></div>

                 {/* Roads */}
                 <svg className="absolute inset-0 w-full h-full pointer-events-none" xmlns="http://www.w3.org/2000/svg">
                   <path d="M-500,800 Q400,400 1200,800 T2400,400" fill="none" stroke={mainRoadStroke} strokeWidth="50" strokeLinecap="round" />
                   <path d="M-500,800 Q400,400 1200,800 T2400,400" fill="none" stroke="#cbd5e1" strokeWidth="2" strokeDasharray="10 10" className="opacity-50" />
                   <path d="M800,-400 Q900,400 800,1200" fill="none" stroke={mainRoadStroke} strokeWidth="45" strokeLinecap="round" />
                   
                   {/* Local Roads */}
                   <path d="M200,200 L1600,1000" fill="none" stroke={isNight ? "#1e293b" : "#e2e8f0"} strokeWidth="25" />
                   <path d="M1600,200 L200,1000" fill="none" stroke={isNight ? "#1e293b" : "#e2e8f0"} strokeWidth="25" />
                   
                   {/* Route */}
                   <path d="M700,500 L900,300" fill="none" stroke={trafficLoad > 80 ? '#ef4444' : '#10b981'} strokeWidth="8" strokeDasharray="12 6" strokeLinecap="round" className="animate-[dash_20s_linear_infinite]" />
                 </svg>
              </div>

              {/* Markers (Relative to Center) */}
              <div className="absolute transform -translate-x-1/2 -translate-y-1/2 z-20 flex flex-col items-center pointer-events-none" style={startPos}>
                <div className="relative">
                   <MapPin className="w-10 h-10 text-green-600 fill-green-600 filter drop-shadow-lg" />
                   <div className="absolute top-1 left-1/2 transform -translate-x-1/2 w-4 h-4 flex items-center justify-center">
                     <Triangle className="w-3 h-3 text-white fill-white" />
                   </div>
                </div>
                <span className="text-[10px] font-bold bg-white/90 dark:bg-slate-800/90 text-slate-800 dark:text-white px-2 py-0.5 rounded shadow mt-1 whitespace-nowrap">{t.start}: {startLoc.split('(')[0]}</span>
              </div>

              <div className="absolute transform -translate-x-1/2 -translate-y-1/2 z-20 flex flex-col items-center pointer-events-none" style={endPos}>
                <div className="relative">
                   <MapPin className="w-10 h-10 text-red-600 fill-red-600 filter drop-shadow-lg" />
                   <div className="absolute top-1 left-1/2 transform -translate-x-1/2 w-4 h-4 flex items-center justify-center">
                     <Square className="w-2.5 h-2.5 text-white fill-white" />
                   </div>
                </div>
                <span className="text-[10px] font-bold bg-white/90 dark:bg-slate-800/90 text-slate-800 dark:text-white px-2 py-0.5 rounded shadow mt-1 whitespace-nowrap">{t.end}: {endLoc.split('(')[0]}</span>
              </div>

              {waypoints.map((wp, idx) => (
                <div key={wp.id} className="absolute z-20 flex flex-col items-center pointer-events-none" style={{ top: `${45 + idx * 5}%`, left: `${50 + idx * 5}%` }}>
                   <MapPin className="w-6 h-6 text-blue-500 fill-blue-500" />
                   <span className="text-[9px] bg-white/80 px-1 rounded mt-0.5">{t.mapStop} {idx + 1}</span>
                </div>
              ))}
            </div>
          </div>
          
          {/* Zoom Buttons Overlay */}
          <div className="absolute bottom-4 right-4 flex flex-col gap-1 z-30">
            <button onClick={handleZoomIn} className="bg-white/90 dark:bg-slate-800/90 p-1.5 rounded border border-slate-300 dark:border-slate-600 shadow hover:bg-slate-100 dark:hover:bg-slate-700">
              <ZoomIn className="w-4 h-4 text-slate-700 dark:text-white" />
            </button>
            <button onClick={handleZoomOut} className="bg-white/90 dark:bg-slate-800/90 p-1.5 rounded border border-slate-300 dark:border-slate-600 shadow hover:bg-slate-100 dark:hover:bg-slate-700">
              <ZoomOut className="w-4 h-4 text-slate-700 dark:text-white" />
            </button>
          </div>
        </>
      )}
      
      {/* Simulation Note */}
      {mapMode === 'sim' && (
        <div className="absolute top-2 right-2 text-[9px] text-slate-500 bg-white/80 px-1 rounded z-30 pointer-events-none flex items-center gap-1">
          <MousePointer2 className="w-3 h-3"/> {t.mapSimNote}
        </div>
      )}

      {/* Transport Icon */}
      <div className="absolute bottom-4 left-4 p-3 bg-white/90 dark:bg-slate-800/90 rounded-full border border-slate-300 dark:border-slate-600 shadow-md z-30 pointer-events-none">
        {transport === 'walk' && <Footprints className="w-6 h-6 text-slate-700 dark:text-white" />}
        {transport === 'bike' && <Bike className="w-6 h-6 text-slate-700 dark:text-white" />}
        {transport === 'scooter' && <ScooterIcon />}
        {transport === 'car' && <Car className="w-6 h-6 text-slate-700 dark:text-white" />}
        {transport === 'bus' && <Bus className="w-6 h-6 text-slate-700 dark:text-white" />}
      </div>
      
      {isNight && <div className="absolute inset-0 bg-blue-900/30 pointer-events-none z-10 mix-blend-multiply"></div>}
    </div>
  );
};

// --- New Components ---

const OfficialResources = ({ lang }) => {
  const t = UI_TEXT[lang];
  const chartData = [120, 115, 118, 110, 105, 98, 92]; 
  
  return (
    <div className="space-y-6">
      <div className="bg-white dark:bg-slate-800 p-6 rounded-sm shadow-sm border-l-4 border-blue-600">
         <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-2 flex items-center gap-2">
           <Building className="w-5 h-5 text-blue-600" /> {t.officialTitle}
         </h3>
         <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">{t.officialChartTitle}</p>
         <div className="h-48 w-full flex items-end justify-between gap-2 border-b border-slate-300 pb-2 px-2">
           {chartData.map((val, i) => (
             <div key={i} className="flex flex-col items-center justify-end h-full flex-1 group">
               <div className="w-full bg-blue-200 dark:bg-blue-900 group-hover:bg-blue-300 transition-all rounded-t-sm relative" style={{ height: `${(val / 150) * 100}%` }}>
                 <span className="absolute -top-5 left-1/2 transform -translate-x-1/2 text-[10px] font-bold text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity">{val}</span>
               </div>
               <span className="text-[10px] text-slate-400 mt-1">201{7+i}</span>
             </div>
           ))}
         </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="bg-white dark:bg-slate-800 p-6 rounded-sm shadow-sm border border-slate-200 dark:border-slate-700">
           <h4 className="font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2"><ExternalLink className="w-4 h-4" /> {t.officialLinks} (Central)</h4>
           <ul className="space-y-3 text-sm">
             <li><a href="#" className="text-blue-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 交通部 (MOTC)</a></li>
             <li><a href="#" className="text-blue-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 168交通安全入口網</a></li>
             <li><a href="#" className="text-blue-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 交通部公路局</a></li>
             <li><a href="#" className="text-blue-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 道安資訊查詢網</a></li>
           </ul>
        </div>
        <div className="bg-white dark:bg-slate-800 p-6 rounded-sm shadow-sm border border-slate-200 dark:border-slate-700">
           <h4 className="font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2"><ExternalLink className="w-4 h-4" /> {t.officialLinks} (Local)</h4>
           <ul className="space-y-3 text-sm">
             <li><a href="#" className="text-emerald-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 台北市交通局</a></li>
             <li><a href="#" className="text-emerald-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 新北市交通局</a></li>
             <li><a href="#" className="text-emerald-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 台中市交通局</a></li>
             <li><a href="#" className="text-emerald-600 hover:underline flex items-center gap-2"><ArrowRight className="w-3 h-3"/> 高雄市交通局</a></li>
           </ul>
        </div>
      </div>
    </div>
  );
};

const Dashboard = ({ 
  activeTab, setActiveTab, lang, toggleLang, theme, toggleTheme, userName, school, currentDateTime, 
  transport, setTransport, timeSlot, setTimeSlot, mapScale, setMapScale, 
  startLocation, setStartLocation, endLocation, setEndLocation, 
  waypoints, handleAddWaypoint, simData, 
  progress, setProgress, pageData, handleLogout
}) => {
  const t = UI_TEXT[lang];
  const [selectedGlossaryIndex, setSelectedGlossaryIndex] = useState("");
  const [mapMode, setMapMode] = useState('real'); // Default to Real Map
  const [openCardId, setOpenCardId] = useState(null); // ID format: 'sectionIndex-cardIndex'
  
  // Section Visibility State
  const [sections, setSections] = useState({ panel: true, map: true, content: true });
  const toggleSection = (sec) => setSections(prev => ({ ...prev, [sec]: !prev[sec] }));

  const [currentQuestions, setCurrentQuestions] = useState([]);
  const [quizAnswers, setQuizAnswers] = useState({});
  const [quizSubmitted, setQuizSubmitted] = useState(false);
  const [quizScore, setQuizScore] = useState(0);

  // Global click listener to close flip cards
  useEffect(() => {
    const handleGlobalClick = () => {
      setOpenCardId(null);
    };
    window.addEventListener('click', handleGlobalClick);
    return () => window.removeEventListener('click', handleGlobalClick);
  }, []);

  useEffect(() => {
    if (pageData && pageData.quizPool) {
      const indices = getRandomIndices(pageData.quizPool.length, QUIZ_DISPLAY_COUNT);
      setCurrentQuestions(indices.map(i => pageData.quizPool[i]));
      setQuizAnswers({});
      setQuizSubmitted(false);
      setQuizScore(0);
    }
  }, [activeTab, lang, pageData]); 

  const handleQuizSubmit = () => {
    let score = 0;
    currentQuestions.forEach((q, idx) => {
      if (quizAnswers[idx] === q.ans) score++;
    });
    setQuizScore(score);
    setQuizSubmitted(true);
    setProgress(prev => ({
      ...prev,
      [activeTab]: { score: Math.max(prev[activeTab].score, score), total: 3, completed: true }
    }));
  };

  const activeGlossaryItem = selectedGlossaryIndex !== "" && pageData?.glossary 
    ? pageData.glossary[selectedGlossaryIndex] 
    : null;

  const handleExportCSV = () => {
    // Generate CSV Content with BOM for Excel compatibility
    const headers = ['Subject (主題)', 'Score (得分)', 'Total (總分)', 'Completed (完成狀態)', 'Date (日期)'];
    const rows = Object.keys(progress).map(key => {
      const p = progress[key];
      const label = key === 'risk' ? UI_TEXT.zh.tabRisk : key === 'guidelines' ? UI_TEXT.zh.tabGuide : UI_TEXT.zh.tabCap;
      return [
        label,
        p.score,
        p.total,
        p.completed ? 'Yes' : 'No',
        new Date().toLocaleDateString()
      ].join(',');
    });

    const csvContent = '\uFEFF' + [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', `RSA_Learning_Record_${userName}_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const LearningRecord = () => (
    <div className="space-y-6">
      <div className="bg-white dark:bg-slate-800 p-6 rounded-sm shadow-sm border-l-4 border-emerald-500">
         <div className="flex justify-between items-start mb-4">
           <h3 className="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"><User className="w-5 h-5 text-emerald-600" /> {t.userProfile}</h3>
           <button onClick={handleExportCSV} className="text-xs flex items-center gap-1 bg-emerald-600 text-white px-3 py-1.5 rounded hover:bg-emerald-700 transition-colors">
             <Download className="w-3 h-3" /> {t.exportCSV}
           </button>
         </div>
         <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
           <div><span className="text-slate-500 block text-xs uppercase font-bold">{t.username}</span><span className="text-slate-800 dark:text-slate-200 font-medium text-lg">{userName}</span></div>
           <div><span className="text-slate-500 block text-xs uppercase font-bold">{t.selectSchool}</span><span className="text-slate-800 dark:text-slate-200">{school}</span></div>
           <div><span className="text-slate-500 block text-xs uppercase font-bold">{t.loginTime}</span><span className="text-slate-800 dark:text-slate-200">{lang === 'zh' ? currentDateTime.toLocaleString('zh-TW') : currentDateTime.toLocaleString('en-US')}</span></div>
         </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
         {['risk', 'guidelines', 'capability'].map((key) => {
           const item = progress[key];
           const percent = Math.round((item.score / item.total) * 100) || 0;
           const label = key === 'risk' ? t.tabRisk : key === 'guidelines' ? t.tabGuide : t.tabCap;
           const statusColor = percent === 100 ? 'text-emerald-600' : percent >= 60 ? 'text-amber-500' : 'text-red-500';
           const statusText = percent === 100 ? t.statusHigh : percent >= 60 ? t.statusMid : t.statusLow;
           return (
             <div key={key} className="bg-white dark:bg-slate-800 p-6 rounded-sm shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col items-center text-center">
               <h4 className="font-bold text-slate-600 dark:text-slate-300 mb-4">{label}</h4>
               <div className="relative w-24 h-24 flex items-center justify-center mb-4">
                  <svg className="w-full h-full transform -rotate-90">
                    <circle cx="48" cy="48" r="40" stroke="#e2e8f0" strokeWidth="8" fill="none" />
                    <circle cx="48" cy="48" r="40" stroke="currentColor" strokeWidth="8" fill="none" className={statusColor} strokeDasharray="251.2" strokeDashoffset={251.2 - (251.2 * percent) / 100} />
                  </svg>
                  <span className={`absolute text-xl font-bold ${statusColor}`}>{percent}%</span>
               </div>
               <div className="w-full flex justify-between text-xs border-t border-slate-100 pt-3 mt-auto">
                  <div className="text-slate-500">{t.score}: <span className="font-bold text-slate-800 dark:text-white">{item.score}/{item.total}</span></div>
                  <div className="text-slate-500">{t.correctRate}: <span className={`font-bold ${statusColor}`}>{statusText}</span></div>
               </div>
             </div>
           );
         })}
      </div>
    </div>
  );

  return (
    <div className={`min-h-screen flex flex-col bg-slate-50 dark:bg-slate-900 transition-colors duration-300 ${theme === 'dark' ? 'dark' : ''}`}>
      {/* Header */}
      <header className="bg-white dark:bg-slate-800 shadow-sm border-b border-emerald-600 sticky top-0 z-50">
        <div className="container mx-auto px-4 py-2 flex justify-between items-center h-20">
          <HeroSection isCompact={true} lang={lang} />
          <div className="hidden md:flex flex-col items-center justify-center flex-grow px-8">
             <h2 className="text-xl font-medium text-slate-700 dark:text-slate-200 italic serif">"{t.slogan}"</h2>
             <div className="text-emerald-600 dark:text-emerald-400 font-semibold text-sm tracking-wide mt-1">{t.valueProp}</div>
          </div>
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2">
              <button onClick={toggleLang} className="flex items-center gap-1 text-xs font-bold text-slate-600 dark:text-slate-300 hover:text-emerald-600 uppercase border px-2 py-1 rounded-sm cursor-pointer"><Globe className="w-3 h-3" /> {lang === 'zh' ? 'EN' : '中'}</button>
              <button onClick={toggleTheme} className="p-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full cursor-pointer">{theme === 'light' ? <Moon className="w-4 h-4" /> : <SunIcon className="w-4 h-4" />}</button>
              <button onClick={handleLogout} className="p-2 text-red-600 dark:text-red-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full cursor-pointer flex items-center gap-1"><LogOut className="w-4 h-4" /></button>
            </div>
            <div className="hidden lg:block text-right border-l border-slate-300 pl-4 ml-2">
              <div className="flex items-center justify-end gap-1 text-xs font-bold text-slate-700 dark:text-white"><User className="w-3 h-3" /> {userName}</div>
              <div className="text-[10px] text-slate-400 truncate max-w-[150px]">{school}</div>
            </div>
          </div>
        </div>
        {/* Section Toggle Bar */}
        <div className="bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 py-1">
          <div className="container mx-auto px-4 flex gap-4 text-[10px] font-bold text-slate-500 uppercase">
             <button onClick={() => toggleSection('panel')} className={`flex items-center gap-1 hover:text-emerald-600 ${!sections.panel && 'opacity-50'}`}>
               {sections.panel ? <Eye className="w-3 h-3"/> : <EyeOff className="w-3 h-3"/>} {t.togglePanel}
             </button>
             <button onClick={() => toggleSection('map')} className={`flex items-center gap-1 hover:text-emerald-600 ${!sections.map && 'opacity-50'}`}>
               {sections.map ? <Eye className="w-3 h-3"/> : <EyeOff className="w-3 h-3"/>} {t.toggleMap}
             </button>
             <button onClick={() => toggleSection('content')} className={`flex items-center gap-1 hover:text-emerald-600 ${!sections.content && 'opacity-50'}`}>
               {sections.content ? <Eye className="w-3 h-3"/> : <EyeOff className="w-3 h-3"/>} {t.toggleContent}
             </button>
          </div>
        </div>
      </header>

      {/* Top Panel (Collapsible) */}
      {sections.panel && (
        <div className="bg-slate-100 dark:bg-slate-950 border-b border-slate-200 dark:border-slate-800 p-4 animate-in slide-in-from-top-2">
          <div className="container mx-auto grid grid-cols-1 md:grid-cols-12 gap-6">
            <div className="md:col-span-3 grid grid-cols-1 gap-2 h-auto">
              <div className="h-28"><ThermometerWidget lang={lang} data={simData} /></div>
              <div className="h-28"><TrafficGauge lang={lang} data={simData} /></div>
            </div>
            <div className="md:col-span-9 flex flex-col gap-3 bg-white dark:bg-slate-800 p-5 rounded-sm border border-slate-200 dark:border-slate-700 shadow-sm h-full justify-center">
               <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                 <div>
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">{t.transport}</label>
                    <div className="flex justify-between bg-slate-50 dark:bg-slate-900 p-1.5 rounded-sm border border-slate-200">
                      {[{ id: 'walk', icon: Footprints }, { id: 'bike', icon: Bike }, { id: 'scooter', icon: ScooterIcon }, { id: 'car', icon: Car }, { id: 'bus', icon: Bus }].map(type => (
                        <button key={type.id} onClick={() => setTransport(type.id)} className={`p-2 rounded-sm transition-all flex-1 flex justify-center ${transport === type.id ? 'bg-emerald-600 text-white shadow-sm' : 'text-slate-400 hover:text-emerald-600'}`}>
                          {type.id === 'scooter' ? <type.icon /> : <type.icon className="w-4 h-4" />}
                        </button>
                      ))}
                    </div>
                 </div>
                 <div>
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">{t.departureTime}</label>
                    <div className="grid grid-cols-5 gap-2">
                      {['08:00', '12:00', '17:00', '22:00', 'now'].map(slot => (
                        <button key={slot} onClick={() => setTimeSlot(slot)} className={`text-[10px] font-bold py-1.5 rounded-sm border ${timeSlot === slot ? 'border-emerald-600 text-emerald-700 bg-emerald-50' : 'border-slate-200 text-slate-500 hover:border-emerald-300'}`}>
                          {slot === 'now' ? 'NOW' : slot.split(':')[0]}
                        </button>
                      ))}
                    </div>
                 </div>
               </div>
               <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 border-t border-slate-100 pt-4 mt-2">
                 <div className="flex gap-4">
                   <div className="flex-1">
                      <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 flex items-center gap-1"><MapPin className="w-3 h-3"/> {t.start}</label>
                      <select value={startLocation} onChange={(e) => setStartLocation(e.target.value)} className="w-full text-xs p-2 rounded border border-slate-300 bg-white dark:bg-slate-700 dark:text-white dark:border-slate-600">
                        {LOCATIONS.start.map(l => <option key={l} value={l}>{l}</option>)}
                      </select>
                   </div>
                   <div className="flex-1">
                      <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 flex items-center gap-1"><MapPin className="w-3 h-3 text-red-500"/> {t.end}</label>
                      <select value={endLocation} onChange={(e) => setEndLocation(e.target.value)} className="w-full text-xs p-2 rounded border border-slate-300 bg-white dark:bg-slate-700 dark:text-white dark:border-slate-600">
                        {LOCATIONS.end.map(l => <option key={l} value={l}>{l}</option>)}
                      </select>
                   </div>
                 </div>
                 
                 <div className="flex items-end justify-between gap-4">
                    <div className="flex-1">
                      <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">{t.scale}</label>
                      <select value={mapScale} onChange={(e) => setMapScale(Number(e.target.value))} className="w-full text-xs p-2 bg-slate-50 border border-slate-200 rounded-sm dark:bg-slate-700 dark:text-white dark:border-slate-600">
                        <option value={100}>1:100 (100m)</option>
                        <option value={300}>1:300 (300m)</option>
                        <option value={1000}>1:1000 (1km)</option>
                      </select>
                    </div>
                    <button onClick={handleAddWaypoint} className="text-xs flex items-center justify-center gap-1 bg-emerald-50 text-emerald-700 px-4 py-2 rounded-sm border border-emerald-200 hover:bg-emerald-100 font-bold h-[34px]"><Plus className="w-3 h-3" /> {t.addStop}</button>
                 </div>
               </div>
            </div>
          </div>
        </div>
      )}

      {/* Map (Collapsible) */}
      {sections.map && (
        <div className="container mx-auto p-4 animate-in fade-in zoom-in-95">
           <MapComponent 
             lang={lang} transport={transport} waypoints={waypoints} 
             mapScale={mapScale} isNight={simData.isNight} trafficLoad={simData.trafficLoad}
             startLoc={startLocation} endLoc={endLocation} mapMode={mapMode} setMapMode={setMapMode}
           />
        </div>
      )}

      {/* Navigation & Content (Collapsible) */}
      {sections.content && (
        <>
          <div className="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-sm">
            <div className="container mx-auto px-4 overflow-x-auto">
              <nav className="flex space-x-8 min-w-max">
                {[{ id: 'risk', label: t.tabRisk, icon: AlertTriangle }, { id: 'guidelines', label: t.tabGuide, icon: BookOpen }, { id: 'capability', label: t.tabCap, icon: GraduationCap }, { id: 'record', label: t.tabRecord, icon: BarChart3 }, { id: 'official', label: t.tabOfficial, icon: Building }].map((tab) => (
                  <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 py-4 px-1 border-b-2 font-medium text-sm transition-colors ${activeTab === tab.id ? 'border-emerald-600 text-emerald-700 dark:text-emerald-400' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}`}>
                    <tab.icon className="w-4 h-4" /> {tab.label}
                  </button>
                ))}
              </nav>
            </div>
          </div>

          <main className="container mx-auto px-4 py-8 flex-grow animate-in slide-in-from-bottom-2">
            {activeTab === 'record' ? <LearningRecord /> : activeTab === 'official' ? <OfficialResources lang={lang} /> : (
              <>
                <div className="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-800 p-6 rounded-sm mb-8 flex items-start gap-4">
                  <Lightbulb className="w-8 h-8 text-emerald-600 mt-1 flex-shrink-0" />
                  <div><h2 className="text-xl font-bold text-slate-800 dark:text-slate-100 mb-2">{pageData.title} {t.summary}</h2><p className="text-slate-600 dark:text-slate-300 leading-relaxed">{pageData.summary}</p></div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                  <div className="md:col-span-2 space-y-8">
                    {/* All sections are now flip cards */}
                    <section>
                      <div className="flex items-center gap-2 mb-4 border-b border-slate-200 pb-2"><BookOpen className="w-5 h-5 text-blue-600" /><h3 className="font-bold text-slate-800 dark:text-white uppercase tracking-wider">{t.knowledge}</h3></div>
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        {pageData.knowledge.map((item, i) => (
                          <FlipCard 
                            key={i} 
                            item={item} 
                            lang={lang} 
                            isOpen={openCardId === `knowledge-${i}`}
                            onToggle={() => setOpenCardId(prev => prev === `knowledge-${i}` ? null : `knowledge-${i}`)}
                          />
                        ))}
                      </div>
                    </section>
                    <section>
                      <div className="flex items-center gap-2 mb-4 border-b border-slate-200 pb-2"><Activity className="w-5 h-5 text-purple-600" /><h3 className="font-bold text-slate-800 dark:text-white uppercase tracking-wider">{t.skills}</h3></div>
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        {pageData.skills.map((item, i) => (
                          <FlipCard 
                            key={i} 
                            item={item} 
                            lang={lang}
                            isOpen={openCardId === `skills-${i}`}
                            onToggle={() => setOpenCardId(prev => prev === `skills-${i}` ? null : `skills-${i}`)}
                          />
                        ))}
                      </div>
                    </section>
                    <section>
                      <div className="flex items-center gap-2 mb-4 border-b border-slate-200 pb-2"><User className="w-5 h-5 text-amber-600" /><h3 className="font-bold text-slate-800 dark:text-white uppercase tracking-wider">{t.attitude}</h3></div>
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        {pageData.attitude.map((item, i) => (
                          <FlipCard 
                            key={i} 
                            item={item} 
                            lang={lang}
                            isOpen={openCardId === `attitude-${i}`}
                            onToggle={() => setOpenCardId(prev => prev === `attitude-${i}` ? null : `attitude-${i}`)}
                          />
                        ))}
                      </div>
                    </section>
                  </div>
                  <div className="space-y-6">
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-sm shadow-sm border border-slate-200 dark:border-slate-700">
                      <div className="flex items-center justify-between mb-4"><h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2"><PlayCircle className="w-5 h-5 text-emerald-600" />{t.quiz}</h3>{quizSubmitted && <span className={`text-sm font-bold px-2 py-1 rounded ${quizScore === 3 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>{t.quizScore}: {quizScore}/{QUIZ_DISPLAY_COUNT}</span>}</div>
                      <div className="space-y-6">
                        {currentQuestions.map((q, idx) => {
                          const isCorrect = quizSubmitted && quizAnswers[idx] === q.ans;
                          return (
                            <div key={idx} className="space-y-2">
                              <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">{idx + 1}. {q.q}</p>
                              <div className="space-y-1">{q.options.map((opt, optIdx) => (<button key={optIdx} onClick={() => !quizSubmitted && setQuizAnswers(prev => ({...prev, [idx]: optIdx}))} disabled={quizSubmitted} className={`w-full text-left text-xs p-2 rounded border transition-colors ${quizAnswers[idx] === optIdx ? 'bg-emerald-50 border-emerald-500 text-emerald-700 font-semibold' : 'border-slate-200 text-slate-600 hover:bg-slate-50'} ${quizSubmitted && optIdx === q.ans ? '!bg-emerald-100 !border-emerald-600 !text-emerald-800' : ''} ${quizSubmitted && quizAnswers[idx] === optIdx && optIdx !== q.ans ? '!bg-red-100 !border-red-400 !text-red-800' : ''}`}><div className="flex justify-between items-center"><span>{opt}</span>{quizSubmitted && optIdx === q.ans && <CheckCircle className="w-4 h-4 text-emerald-600"/>}{quizSubmitted && quizAnswers[idx] === optIdx && optIdx !== q.ans && <XCircle className="w-4 h-4 text-red-600"/>}</div></button>))}</div>
                            </div>
                          );
                        })}
                      </div>
                      <div className="mt-6 pt-4 border-t border-slate-100">{!quizSubmitted ? <button onClick={handleQuizSubmit} className="w-full bg-emerald-600 text-white py-2 rounded-sm text-sm font-bold hover:bg-emerald-700 transition-colors shadow-sm">{t.checkAns}</button> : <button onClick={() => { setQuizSubmitted(false); setQuizAnswers({}); setQuizScore(0); const newIndices = getRandomIndices(pageData.quizPool.length, QUIZ_DISPLAY_COUNT); setCurrentQuestions(newIndices.map(i => pageData.quizPool[i])); }} className="w-full bg-slate-100 text-slate-600 py-2 rounded-sm text-sm font-bold hover:bg-slate-200 transition-colors">{t.tryAgain}</button>}</div>
                    </div>
                    <div className="bg-slate-100 dark:bg-slate-900 p-4 rounded-sm border border-slate-200 dark:border-slate-800">
                       <label className="text-xs font-bold text-slate-500 uppercase block mb-2">{t.glossary}</label>
                       <select className="w-full p-2 text-sm border border-slate-300 rounded-sm bg-white dark:bg-slate-800 dark:text-slate-300 mb-2" value={selectedGlossaryIndex} onChange={(e) => setSelectedGlossaryIndex(e.target.value)}><option value="" disabled>{t.selectTerm}</option>{pageData.glossary.map((g, i) => <option key={i} value={i}>{g.term.split('(')[0]}</option>)}</select>
                       {activeGlossaryItem ? <div className="bg-white dark:bg-slate-800 p-3 rounded-sm border-l-4 border-emerald-500 text-xs animate-in fade-in slide-in-from-top-1"><span className="block font-bold text-slate-700 dark:text-white mb-1">{activeGlossaryItem.term}</span><span className="text-slate-600 dark:text-slate-400 leading-relaxed">{activeGlossaryItem.def}</span></div> : <div className="text-xs text-slate-400 italic text-center p-2">{t.selectTerm}</div>}
                    </div>
                  </div>
                </div>
              </>
            )}
          </main>
        </>
      )}
      
      <footer className="bg-white dark:bg-slate-950 border-t border-slate-200 dark:border-slate-800 py-6 mt-8">
         <div className="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center text-xs text-slate-500 dark:text-slate-400">
            <div className="mb-4 md:mb-0"><p>&copy; {new Date().getFullYear()} RSA Road Safety Advisor. Ver 1.8.0</p><p className="mt-1">{t.lastUpdate}: {lang === 'zh' ? currentDateTime.toLocaleDateString() : currentDateTime.toLocaleDateString('en-US')}</p></div>
            <div className="flex items-center gap-6">
              <a href={LINKS.prof} target="_blank" rel="noopener noreferrer" className="hover:text-emerald-600 transition-colors font-bold">{t.creator}</a><div className="h-3 w-px bg-slate-300"></div>
              <a href={LINKS.ibs} target="_blank" rel="noopener noreferrer" className="hover:text-emerald-600 transition-colors">IBS</a><div className="h-3 w-px bg-slate-300"></div>
              <a href={LINKS.ncnu} target="_blank" rel="noopener noreferrer" className="hover:text-emerald-600 transition-colors">NCNU</a>
            </div>
         </div>
      </footer>
    </div>
  );
};

// --- Main Application Wrapper ---

export default function RSAApp() {
  const [currentPage, setCurrentPage] = useState('login'); 
  const [activeTab, setActiveTab] = useState('risk'); 
  const [theme, setTheme] = useState('light');
  const [lang, setLang] = useState('zh'); 
  
  // Login State
  const [userName, setUserName] = useState('');
  const [userEmail, setUserEmail] = useState('');
  const [school, setSchool] = useState(DEFAULT_SCHOOL);
  const [currentDateTime, setCurrentDateTime] = useState(new Date());

  // Dashboard Shared State
  const [transport, setTransport] = useState('scooter');
  const [timeSlot, setTimeSlot] = useState('now');
  const [mapScale, setMapScale] = useState(300);
  const [startLocation, setStartLocation] = useState(LOCATIONS.start[0]);
  const [endLocation, setEndLocation] = useState(LOCATIONS.end[0]);
  const [waypoints, setWaypoints] = useState([]);
  
  // Persistent Progress
  const [progress, setProgress] = useState({
    risk: { score: 0, total: 3, completed: false },
    guidelines: { score: 0, total: 3, completed: false },
    capability: { score: 0, total: 3, completed: false }
  });

  const t = UI_TEXT[lang];
  const simData = useMemo(() => getSimulationData(timeSlot), [timeSlot]);
  const pageData = activeTab === 'record' || activeTab === 'official' ? null : CONTENT_DATA[activeTab][lang];

  useEffect(() => {
    const timer = setInterval(() => setCurrentDateTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  const toggleTheme = (e) => { e.preventDefault(); setTheme(prev => prev === 'light' ? 'dark' : 'light'); };
  const toggleLang = (e) => { e.preventDefault(); setLang(prev => prev === 'zh' ? 'en' : 'zh'); };

  const handleLogin = (targetTab) => {
    if (!userName) return alert(lang === 'zh' ? '請輸入使用者名稱' : 'Please enter username');
    setActiveTab(targetTab);
    setCurrentPage('dashboard');
  };

  const handleLogout = () => {
    setUserName('');
    setUserEmail('');
    setSchool(DEFAULT_SCHOOL);
    // Reset Progress on Logout if desired, or keep it. Here we keep it for UX demo but usually you reset.
    setProgress({
        risk: { score: 0, total: 3, completed: false },
        guidelines: { score: 0, total: 3, completed: false },
        capability: { score: 0, total: 3, completed: false }
    });
    setCurrentPage('login');
  };

  const handleAddWaypoint = () => {
    if (waypoints.length < 3) setWaypoints([...waypoints, { id: Date.now() }]);
  };

  const renderLogin = () => (
    <div className={`min-h-screen flex flex-col items-center justify-center bg-slate-50 transition-colors duration-500 ${theme === 'dark' ? 'dark bg-slate-900' : ''}`}>
      <div className="w-full max-w-md bg-white dark:bg-slate-800 shadow-2xl rounded-sm overflow-hidden border-t-4 border-emerald-600">
        <div className="bg-slate-100 dark:bg-slate-900 p-2 text-center text-xs text-slate-500 font-mono border-b border-slate-200 dark:border-slate-700">
          {lang === 'zh' ? currentDateTime.toLocaleString('zh-TW', { hour12: false }) : currentDateTime.toLocaleString('en-US', { hour12: false })}
        </div>
        <div className="p-8 flex flex-col gap-6">
          <HeroSection lang={lang} />
          <div className="space-y-4 mt-4">
            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t.username}</label><div className="flex items-center border border-slate-300 rounded-sm px-3 py-2 bg-slate-50 focus-within:ring-1 focus-within:ring-emerald-500"><User className="w-4 h-4 text-slate-400 mr-2" /><input type="text" value={userName} onChange={(e) => setUserName(e.target.value)} className="w-full bg-transparent outline-none text-slate-700 dark:text-slate-200 text-sm" placeholder={t.enterName} /></div></div>
            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t.email}</label><div className="flex items-center border border-slate-300 rounded-sm px-3 py-2 bg-slate-50 focus-within:ring-1 focus-within:ring-emerald-500"><Mail className="w-4 h-4 text-slate-400 mr-2" /><input type="email" value={userEmail} onChange={(e) => setUserEmail(e.target.value)} className="w-full bg-transparent outline-none text-slate-700 dark:text-slate-200 text-sm" placeholder={t.enterEmail} /></div></div>
            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">{t.selectSchool}</label><div className="relative"><select value={school} onChange={(e) => setSchool(e.target.value)} className="w-full appearance-none border border-slate-300 rounded-sm px-3 py-2 bg-slate-50 text-slate-700 dark:text-slate-200 text-sm pr-8 focus:ring-1 focus:ring-emerald-500 outline-none">{SCHOOLS.map(s => <option key={s} value={s}>{s}</option>)}</select><div className="absolute right-3 top-2.5 pointer-events-none"><ArrowRight className="w-4 h-4 text-slate-400 rotate-90" /></div></div></div>
          </div>
          <div className="space-y-3 mt-4">
            {[{ id: 'risk', label: t.btnRisk }, { id: 'guidelines', label: t.btnGuide }, { id: 'capability', label: t.btnCap }, { id: 'record', label: t.btnRecord }].map((btn) => (
              <button key={btn.id} onClick={() => handleLogin(btn.id)} className="w-full group flex items-center justify-between px-4 py-3 bg-white border border-emerald-600 text-emerald-700 hover:bg-emerald-600 hover:text-white transition-all duration-200 rounded-sm shadow-sm">
                <span className="font-semibold text-sm">{btn.label}</span>
                <ArrowRight className="w-4 h-4 transform group-hover:translate-x-1 transition-transform" />
              </button>
            ))}
          </div>
          <div className="pt-6 border-t border-slate-100 dark:border-slate-700 text-center">
             <div className="flex items-center justify-center gap-4 mb-4">
               <button onClick={toggleLang} className="flex items-center gap-1 text-xs font-bold text-slate-500 hover:text-emerald-600 uppercase border px-2 py-1 rounded-sm cursor-pointer z-10"><Globe className="w-3 h-3" /> {lang === 'zh' ? 'EN' : '中'}</button>
               <button onClick={toggleTheme} className="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full cursor-pointer z-10">{theme === 'light' ? <Moon className="w-4 h-4" /> : <SunIcon className="w-4 h-4" />}</button>
             </div>
            <a href={LINKS.prof} target="_blank" rel="noopener noreferrer" className="text-xs text-slate-400 font-serif hover:text-emerald-600 transition-colors">{t.creator}</a>
          </div>
        </div>
      </div>
    </div>
  );

  return currentPage === 'login' ? renderLogin() : (
    <Dashboard 
      activeTab={activeTab} setActiveTab={setActiveTab} 
      lang={lang} toggleLang={toggleLang} 
      theme={theme} toggleTheme={toggleTheme}
      userName={userName} school={school} currentDateTime={currentDateTime}
      transport={transport} setTransport={setTransport}
      timeSlot={timeSlot} setTimeSlot={setTimeSlot}
      mapScale={mapScale} setMapScale={setMapScale}
      startLocation={startLocation} setStartLocation={setStartLocation}
      endLocation={endLocation} setEndLocation={setEndLocation}
      waypoints={waypoints} handleAddWaypoint={handleAddWaypoint}
      simData={simData} progress={progress} setProgress={setProgress}
      pageData={pageData} handleLogout={handleLogout}
    />
  );
}